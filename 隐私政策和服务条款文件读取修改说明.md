# 隐私政策和服务条款文件读取修改说明

## 修改概述

本次修改将隐私政策（Privacy Policy）和服务条款（Terms of Service）页面从硬编码内容改为直接读取public目录下的对应markdown文件，实现了内容与代码的分离。**重要：本方案使用Edge Runtime，完全兼容Cloudflare Pages部署。**

## ⚠️ Cloudflare Pages 兼容性说明

### 问题背景
- **Cloudflare Pages** 使用 `@cloudflare/next-on-pages` 适配器，仅支持 **Edge Runtime**
- **Node.js Runtime** 不兼容 Cloudflare Pages（如`fs`文件系统操作）
- 使用 `export const runtime = 'nodejs'` 会导致 Cloudflare Pages 部署失败

### 解决方案
我们采用了 **Edge Runtime 兼容** 的方案：
- ✅ 使用 `export const runtime = 'edge'`
- ✅ 通过 `fetch()` 读取 public 目录下的 markdown 文件
- ✅ 使用纯 JavaScript 正则表达式进行简单的 markdown 转换
- ✅ 完全兼容 Cloudflare Pages 部署

## 修改的文件

### 1. 页面组件文件
- `app/[locale]/privacy/page.tsx` - 隐私政策页面
- `app/[locale]/terms/page.tsx` - 服务条款页面

### 2. 移除的依赖
- ~~`gray-matter`~~ - 不再使用（Node.js依赖）
- ~~`remark`~~ - 不再使用（Node.js依赖）
- ~~`remark-html`~~ - 不再使用（Node.js依赖）

### 3. 数据源文件（已存在于public目录）
- `public/privacy-policy.md` - 英文隐私政策
- `public/privacy-policy-zh.md` - 中文隐私政策
- `public/terms-of-service.md` - 英文服务条款
- `public/terms-of-service-zh.md` - 中文服务条款

## 主要变更

### 1. 运行时环境
- **现在**: `export const runtime = 'edge'` ✅
- **兼容**: Cloudflare Pages 完全支持

### 2. 内容获取方式变更
- **原来**: 硬编码HTML字符串
- **现在**: 通过 `fetch()` 动态读取markdown文件并转换为HTML

### 3. Markdown处理方式
- **不使用**: Node.js 依赖的 remark 库
- **改用**: 纯 JavaScript 正则表达式处理
- **支持**: 标题、粗体、斜体、列表、段落等基本markdown语法

### 4. 国际化支持
- 根据`locale`参数自动选择对应语言的文件：
  - `zh`: 使用 `*-zh.md` 文件
  - `en`: 使用 `*.md` 文件

### 5. 错误处理
- 添加了网络请求错误的异常处理
- 当文件读取失败时，显示友好的错误信息

## 技术实现细节

### 文件读取流程（Edge Runtime 兼容）
```typescript
async function getPrivacyPolicy(locale: string) {
  try {
    // 1. 根据语言选择文件
    const fileName = locale === 'zh' ? 'privacy-policy-zh.md' : 'privacy-policy.md';
    
    // 2. 通过fetch读取public目录下的文件
    const response = await fetch(`${process.env.NEXT_PUBLIC_SITE_URL || 'http://localhost:3000'}/${fileName}`);
    
    if (!response.ok) {
      throw new Error(`Failed to fetch: ${response.status}`);
    }
    
    // 3. 获取文件内容
    const content = await response.text();
    
    // 4. 简单的markdown转换（纯JavaScript正则表达式）
    const cleanContent = content
      .replace(/^---[\s\S]*?---\n/, '') // 移除front matter
      .replace(/^# (.+)$/gm, '<h1>$1</h1>') // 转换标题
      .replace(/^## (.+)$/gm, '<h2>$1</h2>')
      .replace(/^### (.+)$/gm, '<h3>$1</h3>')
      .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>') // 转换粗体
      .replace(/\*(.+?)\*/g, '<em>$1</em>') // 转换斜体
      .replace(/^- (.+)$/gm, '<li>$1</li>') // 转换列表项
      .replace(/\n\n/g, '</p><p>') // 转换段落
      .replace(/^(.+)$/gm, '<p>$1</p>') // 包装段落
      .replace(/<p><h/g, '<h') // 清理标题
      .replace(/<\/h([1-6])><\/p>/g, '</h$1>')
      .replace(/<p><li>/g, '<li>')
      .replace(/<\/li><\/p>/g, '</li>');
    
    // 5. 将分散的li标签包装在ul中
    const withLists = cleanContent.replace(/(<li>.*?<\/li>(?:\s*<li>.*?<\/li>)*)/g, '<ul>$1</ul>');
    
    return withLists;
  } catch (error) {
    // 6. 错误处理
    console.error('Error reading privacy policy file:', error);
    return fallbackContent;
  }
}
```

### 样式类配置
```typescript
<div 
  className="prose prose-lg max-w-none prose-headings:text-foreground prose-p:text-muted-foreground prose-strong:text-foreground prose-ul:text-muted-foreground prose-li:text-muted-foreground"
  dangerouslySetInnerHTML={{ __html: content }} 
/>
```

## 优势和效果

### 1. Cloudflare Pages 兼容性 ⭐
- **Edge Runtime**: 完全兼容 Cloudflare Pages
- **无Node.js依赖**: 不使用文件系统或其他Node.js特有API
- **部署成功**: 能够在 Cloudflare Pages 上正常部署和运行

### 2. 内容管理优势
- **易于维护**: 内容与代码分离，法务团队可以直接编辑markdown文件
- **版本控制**: markdown文件的变更可以通过Git跟踪
- **格式统一**: 使用标准markdown格式，便于编辑和预览

### 3. 开发效率提升
- **代码简化**: 移除了大量硬编码的HTML字符串
- **轻量依赖**: 不再需要复杂的markdown处理库
- **单一数据源**: 避免了代码和文档内容不同步的问题

### 4. 用户体验改进
- **网络获取**: 通过标准HTTP请求获取内容
- **样式一致**: 统一的prose样式确保良好的阅读体验
- **响应式**: 保持原有的响应式布局和主题适配

## 遵循的设计原则

### 1. 平台兼容性原则
- 遵循 Cloudflare Pages 的 Edge Runtime 限制
- 使用平台原生支持的 Web API（fetch）

### 2. KISS原则（Keep It Simple, Stupid）
- 简化markdown处理，不依赖外部库
- 使用简单易懂的正则表达式替换

### 3. 渐进增强原则
- 基本功能（读取文件）在所有环境下都能工作
- markdown转换提供良好的视觉体验

### 4. 容错设计
- 网络请求失败时有优雅的降级处理
- 错误信息对用户友好

## Cloudflare Pages 部署注意事项

### ✅ 兼容特性
1. **Edge Runtime**: 使用 `export const runtime = 'edge'`
2. **Web标准API**: 使用 `fetch()` 而非 `fs`
3. **纯JavaScript**: 不依赖Node.js特有模块
4. **静态资源**: markdown文件在public目录下，可正常访问

### ⚠️ 环境变量
确保设置正确的 `NEXT_PUBLIC_SITE_URL` 环境变量：
- **开发环境**: `http://localhost:3000`
- **生产环境**: 您的实际域名（如 `https://recipe-easy.com`）

### 📋 部署清单
- [x] 使用 Edge Runtime
- [x] 移除 Node.js 依赖
- [x] markdown文件在public目录
- [x] 设置正确的环境变量
- [x] 测试网络请求正常

## 注意事项

1. **运行时要求**: 修改后的页面使用Edge Runtime，完全兼容Cloudflare Pages
2. **文件依赖**: 确保public目录下的markdown文件存在且可通过HTTP访问
3. **网络依赖**: 页面内容通过网络请求获取，确保文件可访问性
4. **Markdown限制**: 目前支持基本markdown语法，如需复杂格式可扩展正则表达式

## 后续建议

1. **内容更新流程**: 建立明确的markdown文件更新和审核流程
2. **自动化测试**: 添加文件读取和markdown渲染的单元测试
3. **缓存优化**: 考虑添加适当的缓存策略
4. **监控**: 添加网络请求失败的监控
5. **markdown扩展**: 根据需要扩展支持更多markdown语法

---

**修改完成时间**: 2024年12月  
**修改人员**: AI助手  
**影响范围**: 隐私政策和服务条款页面  
**兼容性**: ✅ Cloudflare Pages Edge Runtime 